import { useState } from 'react';
import { MapContainer, TileLayer, Marker, Popup, Polyline } from 'react-leaflet';
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';

// Fix Leaflet default icon issue in React
delete (L.Icon.Default.prototype as any)._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',
  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
});

// Lucide icons replacement (using emoji for now - can install lucide-react later)
// Types
interface IndustrialSite {
  id: number;
  name: string;
  location: string;
  lat: number;
  lon: number;
  type: string;
  emissions: {
    co2?: number;
    nox?: number;
    sox?: number;
    nitrates?: number;
    phosphorus?: number;
  };
  publicClaim: string;
  reality: string;
  ehi: number;
  year: number;
}

interface TimelineEvent {
  year: number;
  event: string;
  type: 'tech' | 'promise' | 'pr' | 'funding' | 'reality';
}

// Mock Data - Combined from both versions
const mockIndustrialSites: IndustrialSite[] = [
  {
    id: 1,
    name: "SIJ Acroni",
    location: "Jesenice",
    lat: 46.4319,
    lon: 14.0536,
    type: "Steel Production",
    emissions: { co2: 196000, nox: 450, sox: 230 },
    publicClaim: "51% zmanj≈°anje emisij do 2030",
    reality: "11.7% reduction (2024) - EAF tehnologija od 1960-ih",
    ehi: 0.62,
    year: 2024
  },
  {
    id: 2,
    name: "Lafarge/Holcim Anhovo",
    location: "Anhovo",
    lat: 46.1547,
    lon: 15.0497,
    type: "Cement Production",
    emissions: { co2: 450000, nox: 890, sox: 620 },
    publicClaim: "Trajnostno poslovanje, Net-zero by 2050",
    reality: "Closed 2015 - 450,000 t CO‚ÇÇ/year legacy",
    ehi: 0.89,
    year: 2015
  },
  {
    id: 3,
    name: "Ljubljana ƒåistilna",
    location: "Ljubljana",
    lat: 46.0569,
    lon: 14.5058,
    type: "Wastewater Treatment",
    emissions: { nitrates: 1.64, phosphorus: 0.42 },
    publicClaim: "Zelena prestolnica Evrope",
    reality: "High NO3 concentrations - 1.64 mg/L",
    ehi: 0.69,
    year: 2024
  },
  {
    id: 4,
    name: "Cinkarna Celje",
    location: "Celje",
    lat: 46.2361,
    lon: 15.2676,
    type: "Chemical Production",
    emissions: { co2: 85000 },
    publicClaim: "Zmanj≈°anje te≈ækih kovin",
    reality: "-15% heavy metals (2024) - 15 t Pb, 18 t Zn",
    ehi: 0.60,
    year: 2024
  },
  {
    id: 5,
    name: "NEK Kr≈°ko",
    location: "Kr≈°ko",
    lat: 45.9381,
    lon: 15.5151,
    type: "Nuclear Power",
    emissions: { co2: 0 },
    publicClaim: "Safe, minimal environmental impact",
    reality: "+2-3¬∞C thermal discharge, transparent monitoring",
    ehi: 0.42,
    year: 2024
  }
];

// Sava River path
const savaPath: [number, number][] = [
  [46.4319, 14.0536], // Jesenice
  [46.1547, 15.0497], // Anhovo
  [46.0569, 14.5058], // Ljubljana
  [46.2361, 15.2676], // Celje
  [45.9381, 15.5151]  // Kr≈°ko
];

// Timeline
const sijTimeline: TimelineEvent[] = [
  { year: 1960, event: "EAF tehnologija uvedena", type: "tech" },
  { year: 2020, event: "Zaveza: -51% emisij do 2030", type: "promise" },
  { year: 2023, event: "ResponsibleSteel certifikacija", type: "pr" },
  { year: 2024, event: "EBRD posojilo ‚Ç¨230M za 'dekarbonizacijo'", type: "funding" },
  { year: 2025, event: "Dejanske emisije: ?", type: "reality" }
];

function App() {
  const [activeDomain, setActiveDomain] = useState('zemljevid');
  const [selectedSite, setSelectedSite] = useState<IndustrialSite | null>(null);
  const [layerVisibility, setLayerVisibility] = useState({
    promises: true,
    reality: true,
    networks: false
  });

  const domains = [
    { id: 'zemljevid', icon: MapPin, label: 'Zemljevid Resnice', emoji: 'üó∫Ô∏è' },
    { id: 'casovnica', icon: TrendingDown, label: 'ƒåasovna Linija', emoji: '‚è≥' },
    { id: 'omrezja', icon: Network, label: 'Omre≈æja Moƒçi', emoji: 'üï∏Ô∏è' },
    { id: 'akcije', icon: Target, label: 'Akcijski Center', emoji: '‚ö°' },
    { id: 'resonanca', icon: MapPin, label: 'Karta Resonanc', emoji: 'üåç' }
  ];

  const avgEHI = (mockIndustrialSites.reduce((sum, site) => sum + site.ehi, 0) / mockIndustrialSites.length).toFixed(2);

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-slate-100">
      {/* Header */}
      <header className="border-b border-slate-800 bg-slate-950/50 backdrop-blur">
        <div className="max-w-7xl mx-auto px-4 py-6">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-3xl font-bold bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent">
                üõ∞Ô∏è ORIONOV SVETILNIK
              </h1>
              <p className="text-slate-400 text-sm mt-1">Projekt za Informacijsko Praviƒçnost</p>
            </div>
            <div className="text-right">
              <div className="text-xs text-slate-500">Indeks Ekolo≈°ke Hipokrizije</div>
              <div className={`text-3xl font-bold ${Number(avgEHI) > 0.6 ? 'text-red-400' : 'text-yellow-400'}`}>
                {avgEHI}
              </div>
              <div className="text-xs text-slate-400">
                {Number(avgEHI) > 0.6 ? 'VISOKA HIPOKRIZIJA' : 'ZMERNA HIPOKRIZIJA'}
              </div>
            </div>
          </div>
        </div>
      </header>

      {/* Domain Navigation */}
      <nav className="border-b border-slate-800 bg-slate-950/30">
        <div className="max-w-7xl mx-auto px-4">
          <div className="flex space-x-1 overflow-x-auto">
            {domains.map(domain => {
              const Icon = domain.icon;
              return (
                <button
                  key={domain.id}
                  onClick={() => setActiveDomain(domain.id)}
                  className={`flex items-center space-x-2 px-6 py-4 border-b-2 transition-all whitespace-nowrap ${
                    activeDomain === domain.id
                      ? 'border-cyan-400 text-cyan-400 bg-slate-900/50'
                      : 'border-transparent text-slate-400 hover:text-slate-200 hover:bg-slate-900/30'
                  }`}
                >
                  <span>{domain.emoji}</span>
                  <Icon className="w-4 h-4" />
                  <span className="font-medium">{domain.label}</span>
                </button>
              );
            })}
          </div>
        </div>
      </nav>

      {/* Main Content */}
      <main className="max-w-7xl mx-auto px-4 py-8">
        {activeDomain === 'zemljevid' && (
          <ZemljevidResnice
            sites={mockIndustrialSites}
            selectedSite={selectedSite}
            setSelectedSite={setSelectedSite}
            layerVisibility={layerVisibility}
            setLayerVisibility={setLayerVisibility}
          />
        )}
        {activeDomain === 'casovnica' && <CasovnaLinija timeline={sijTimeline} />}
        {activeDomain === 'omrezja' && <OmrezjaMoci />}
        {activeDomain === 'akcije' && <AkcijskiCenter />}
        {activeDomain === 'resonanca' && <KartaResonanc sites={mockIndustrialSites} />}
      </main>

      {/* Footer */}
      <footer className="border-t border-slate-800 mt-12 py-6 text-center text-slate-500 text-sm">
        <p>"Resnica ni tisto, kar ti povedo. Resnica je tisto, kar sam najde≈°."</p>
        <p className="mt-2">Projekt Orion ‚Ä¢ Oktober 2025</p>
      </footer>
    </div>
  );
}

export default App;
